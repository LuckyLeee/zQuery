(function(A){var B={};B.TreeNode=A.Base.Event.extend({init:function(D){A.extend(this,{panel:null,parentNodeTemplate:'<dl><$ var _checkedClass = GlobalData.data.IsChecked == true ? " select" : "",               _checkClass = GlobalData.isCheckBox == true ? "check" : ""; $><dt class="<$= _checkClass $>"><button class="close" data-id="<$= GlobalData.data.TreeId $>"></button><$ if(GlobalData.isCheckBox){ $><a class="checkbox<$= _checkedClass $>" data-id="<$= GlobalData.data.TreeId $>"></a><$ } $><a href="javascript:" data-id="<$= GlobalData.data.TreeId $>"><$ if(GlobalData.data.Icon){ $><i class="<$= GlobalData.data.Icon $>"></i><$ } $><$= GlobalData.formatter == null ? GlobalData.data.Name : GlobalData.formatter(GlobalData.data) $></a></dt></dl>',nodeAllTemplate:'<$ for(var i = 0,l = GlobalData.nodeList.length;i < l;i++){            var item = GlobalData.nodeList[i],                _checkedClass = item.IsChecked == true ? " select" : "",                _class = i + 1 == GlobalData.nodeList.length ? "last " : "",                _checkClass = GlobalData.isCheckBox == true ? "check" : "";            if(item.HasChild){ $><dd class="<$= _class + _checkClass $>" style="display:none"><dl><dt class="<$= _checkClass $>"><button class="close" data-id="<$= item.TreeId $>"></button><$ if(GlobalData.isCheckBox){ $><a class="checkbox<$= _checkedClass $>" data-id="<$= item.TreeId $>" ></a><$ } $><a href="javascript:" data-id="<$= item.TreeId $>"><$ if(item.Icon){ $><i class="<$= item.Icon $>"></i><$ } $><$= GlobalData.formatter == null ? item.Name : GlobalData.formatter(item) $></a></dt><$= $.template.replace(GlobalData.template,{nodeList:item.NodeList,template:GlobalData.template,isCheckBox:GlobalData.isCheckBox,formatter:GlobalData.formatter}) $></dl></dd><$ }else{ $><dd class="<$= _class + _checkClass $>" style="display:none"><$ if(GlobalData.isCheckBox){ $><a class="checkbox<$= _checkedClass $>" data-id="<$= item.TreeId $>"></a><$ } $><a href="javascript:" data-id="<$= item.TreeId $>" ><$ if(item.Icon){ $><i class="<$= item.Icon $>"></i><$ } $><$= GlobalData.formatter == null ? item.Name : GlobalData.formatter(item) $></a></dd><$ } $><$ } $>',nodeTemplate:'<$ for(var i = 0,l = GlobalData.data.length;i < l;i++){            var item = GlobalData.data[i],                _class = i + 1 == GlobalData.data.length ? "last " : "",                _checkClass = GlobalData.isCheckBox == true ? "check" : "";            if(item.HasChild){ $><dd class="<$= _class + _checkClass $>" ><dl><dt class="<$= _checkClass $>"><button class="close" data-id="<$= item.TreeId $>"></button><$ if(GlobalData.isCheckBox){ $><a class="checkbox" data-id="<$= item.TreeId $>"></a><$ } $><a href="javascript:" data-id="<$= item.TreeId $>"><$ if(item.Icon){ $><i class="<$= item.Icon $>"></i><$ } $><$= GlobalData.formatter == null ? item.Name : GlobalData.formatter(item) $></a></dt></dl></dd><$ }else{ $><dd class="<$= _class + _checkClass $>" ><$ if(GlobalData.isCheckBox){ $><a class="checkbox" data-id="<$= item.TreeId $>"></a><$ } $><a href="javascript:" data-id="<$= item.TreeId $>"><$ if(item.Icon){ $><i class="<$= item.Icon $>"></i><$ } $><$= GlobalData.formatter == null ? item.Name : GlobalData.formatter(item) $></a></dd><$ }        } $>',seletedNode:null,cacheTreeParent:{},treeDataList:{},GlobalGuid:0,prevNodeIndex:0},D);this.setOptions();this.bindEvent();},setOptions:function(){this.loadPage();},bindEvent:function(){var D=this;this.panel.on("click.treeView",function(F){var G=F.target,E=A(G);if(G.tagName=="A"){if(E.hasClass("checkbox")){D.check(E);}else{D.change(E);}}else{if(G.tagName=="BUTTON"){D.showNode(E);}}});this.panel.on("dblclick.treeView",function(F){var G=F.target;if(G.tagName=="A"){var E=A(G);if(!E.hasClass("checkbox")){if(D.treeDataList[E.data("id")].HasChild){D.showNode(false==D.isCheckBox?E.prev():E.prev().prev());}if(D.onDoubleClick&&A.type(D.onDoubleClick)==="function"){D.onDoubleClick.call(null,D.treeDataList[E.data("id")],E);}}}});},loadPage:function(){this.formatData();if(this.rootData&&this.url){this.panel.html(A.template.replace(this.parentNodeTemplate,{data:this.rootData,isCheckBox:this.isCheckBox,json:A.jsonToString(this.rootData),formatter:this.formatter}));this.loadNode(this.rootData.Id,this.panel.find("dl:eq(0)"));}else{if(this.datasource){this.panel.html(A.template.replace(this.parentNodeTemplate,{data:this.datasource,isCheckBox:this.isCheckBox,formatter:this.formatter}));if(this.datasource.HasChild){this.panel.find("dl:eq(0)").append(A.template.replace(this.nodeAllTemplate,{nodeList:this.datasource.NodeList,template:this.nodeAllTemplate,isCheckBox:this.isCheckBox,formatter:this.formatter}));this.datasource&&this.showNode(this.panel.find("button:eq(0)"));}}else{if(this.rootData&&this.ajaxFun){this.panel.html(A.template.replace(this.parentNodeTemplate,{data:this.rootData,isCheckBox:this.isCheckBox,json:A.jsonToString(this.rootData),formatter:this.formatter}));this.showNode(this.panel.find("button:eq(0)"));}else{A.error("tree data is null");}}}},formatData:function(){if(this.datasource){this.datasource.TreeId=this.createID();this.treeDataList[this.datasource.TreeId]=this.datasource;this.formatNodeData(this.datasource.NodeList,this.datasource.TreeId);}else{if(this.rootData){this.rootData.TreeId=this.createID();this.treeDataList[this.rootData.TreeId]=this.rootData;}}},formatNodeData:function(D,F){for(var E=0,G=D.length;E<G;E++){D[E].TreeId=this.createID();this.treeDataList[D[E].TreeId]=D[E];this.cacheTreeParent[D[E].TreeId]=this.treeDataList[F];if(D[E].HasChild){this.formatNodeData(D[E].NodeList,D[E].TreeId);}}},createID:function(){return this.GlobalGuid++;},loadFunNode:function(D,F,G){for(var E=D.length-1;E>=0;E--){D[E].TreeId=this.createID();this.treeDataList[D[E].TreeId]=D[E];this.cacheTreeParent[D[E].TreeId]=this.treeDataList[this.seletedNode.data("id")];}F.append(A.template.replace(this.nodeTemplate,{data:D,isCheckBox:this.isCheckBox,formatter:this.formatter}));F.data("__loaded__",true);},loadNode:function(E,F,G){var D={};D[this.ajaxId]=E,_this=this;A.ajax({url:this.url,context:D,method:this.ajaxType,success:function(H){F.append(A.template.replace(_this.nodeTemplate,{data:H,isCheckBox:_this.isCheckBox,formatter:_this.formatter}));F.data("__loaded__",true);}});},showNode:function(F){var E=F.parent().parent(),D=false==this.isCheckBox?F.next():F.next().next();if(this.isOpenChange){this.change(D);}if(E.data("__loaded__")||this.datasource){if(F.hasClass("open")){F.removeClass("open").addClass("close");E.children("dd").hide();}else{F.removeClass("close").addClass("open");E.children("dd").show();}}else{if(F.hasClass("open")){F.removeClass("open").addClass("close");}else{F.removeClass("close").addClass("open");}if(this.url){this.loadNode(F.data("id"),E,D);}else{if(this.ajaxFun&&A.type(this.ajaxFun)==="function"){this.ajaxFun.call(this,this.treeDataList[F.data("id")],E,D);}}}},check:function(D){var E=D.parent()[0].tagName=="DT"?true:false;if(D.hasClass("select")){D.removeClass("select");if(E){D.parent().parent().find("dd a.checkbox").removeClass("select");}else{D.find("a.checkbox").removeClass("select");}this.setParentNode(D);}else{D.addClass("select");if(E){D.parent().parent().find("dd a.checkbox").addClass("select");}else{D.find("a.checkbox").addClass("select");}this.setParentNode(D);}},change:function(D){if(this.seletedNode){this.seletedNode.removeClass(this.className);}D.addClass(this.className);this.seletedNode=D;if(A.type(this.onChange)==="function"){this.onChange.call(this,this.treeDataList[D.data("id")],D);}},setParentNode:function(F,I){var D=F.parent().parent();if(D.length>0&&D[0].tagName=="DL"){var E=D.children("dt").children("a.checkbox"),H=D.children("dd").find(">a.checkbox,>dl>dt>a.checkbox,>dl>dd>a.checkbox"),G=true;H.each(function(K,J){if(!A(J).hasClass("select")){G=false;return;}});if(G){E.addClass("select");}else{E.removeClass("select");}this.setParentNode(D);}return;},getSelectedData:function(){var E=[],D=this;this.panel.find("a.checkbox").each(function(G,H){var F=A(H);if(F.hasClass("select")){E.push(D.treeDataList[F.data("id")]);}});return E;},getParentNode:function(D){return this.cacheTreeParent[D.TreeId];},getParentNodeALL:function(E){var H=this,F=[],D=null;function G(I){D=H.cacheTreeParent[I];if(!D){return;}F.push(D);arguments.callee(D.TreeId);}G(E.TreeId);D=null;return F;},setNodeByName:function(D){var E=null,F=null,G=false;for(var H in this.treeDataList){if(this.treeDataList[H].Name.indexOf(D)!==-1){if(~~H<=~~this.prevNodeIndex&&!G){E=H;F=this.treeDataList[H];G=true;continue;}if(~~this.prevNodeIndex==0||~~H>~~this.prevNodeIndex){this.prevNodeIndex=H;this.setNodeByData(this.treeDataList[H]);return;}}}this.prevNodeIndex=E;this.setNodeByData(F);},setNodeByData:function(I){var F=this.getParentNodeALL(I);for(var G=F.length-1;G>=0;G--){var E=this.panel.find("button[data-id="+F[G].TreeId+"]");if(E.hasClass("close")){this.showNode(E);}}var H=this.panel.find("a[data-id="+I.TreeId+"]");this.change(this.isCheckBox==false?H:H.eq(1));var D=this;setTimeout(function(){var J=H.offset().top+D.panel.parent().scrollTop()-D.panel.parent().offset().top;D.panel.parent().scrollTop(J);},0);}});var C=function(D,E){this.opts={formatter:null,rootData:null,datasource:null,ajaxFun:null,url:null,ajaxId:"nodeId",ajaxType:"get",isCheckBox:false,className:"active",isOpenChange:true,onDoubleClick:null,onChange:null,onLoad:null,onFisrtLoad:null};A.extend(true,this.opts,E);this.target=A(D);this.init();this.initialize();};C.prototype={init:function(){this.target.html("");},initialize:function(){this.setOptions();},setOptions:function(){var D=A('<div class="ntree"></div>');this.target.html(D);this.tree=new B.TreeNode(A.extend({panel:D},this.opts));},GetSelectedData:function(){return this.tree.getSelectedData();},SetNodeByName:function(D){this.tree.setNodeByName(D);}};A.fn.extend({TreeView:function(D){var E={};if(typeof D!=="undefined"){A.extend(true,E,D);}C["instance"]=new C(this,E);return C["instance"];}});})(jQuery);